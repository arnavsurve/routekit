<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Routekit Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        .nav {
            background-color: #f8f9fa;
            padding: 15px 0;
            border-bottom: 1px solid #eaeaea;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-brand {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }
        .nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        .nav li {
            margin-left: 20px;
        }
        .nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 5px 0;
        }
        .nav a:hover {
            color: #007bff;
        }
        .nav a.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        #messages { 
            flex-grow: 1;
            overflow-y: auto;
            padding: 3rem;
        }
        #form { 
            display: flex;
            padding: 1rem;
        }
        #input { 
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        #input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        #form button {
            background-color: black;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        #form button:hover {
            background-color: rgba(0, 0, 0, 0.883);
        }
        pre { 
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .message-container {
            margin-bottom: 1rem;
        }
        .tool-call, .tool-result, .system-error {
            background-color: #f0f0f0;
            border-left: 4px solid #ccc;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            border-radius: 4px;
            overflow-wrap: break-word;
        }
        .tool-result { border-left-color: #4caf50; }
        .system-error { border-left-color: #f44336; }
        
        /* Styles for the preview and expandable content */
        .preview-text {
            color: #555;
            padding-left: 0.5rem;
            display: inline;
            font-style: italic;
        }
        .details-summary {
            cursor: pointer;
            outline: none; /* Removes the focus ring on click */
        }
        .details-summary::-webkit-details-marker {
            color: #555;
        }
        .expanded-content {
            margin-top: 0.75rem;
            max-height: 15rem; /* Increased height for more content */
            overflow-y: auto;
            border-top: 1px solid #ddd;
            padding-top: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">Routekit</a>
            <ul>
                <li><a href="/" class="active">Chat</a></li>
                <li><a href="/settings.html">Settings</a></li>
            </ul>
        </div>
    </div>
    <div id="messages"></div>
    <div id="form-container">
        <form id="form" action="">
            <input id="input" autocomplete="off"/><button>⏎</button>
        </form>
    </div>
    <script>
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');

        document.addEventListener('DOMContentLoaded', async () => {
            const userEmail = await checkAuth();
            if (!userEmail) return;
        });

        // Establish WebSocket connection
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        ws.onopen = () => {
            appendMessage("System", "Connected to Routekit backend.");
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleMessage(data);
        };
        
        ws.onclose = () => {
            appendMessage("System", "Connection closed.");
        };

        function handleMessage(data) {
            switch (data.type) {
                case 'agent_response':
                    appendMessage(data.sender, data.content);
                    break;
                case 'tool_start':
                    appendToolCall(data.content.name, data.content.args);
                    break;
                case 'tool_result':
                    appendToolResult(data.content.name, data.content.result, false);
                    break;
                case 'system_error':
                    appendToolResult(data.content.name, data.content.result, true);
                    break;
                default:
                    appendMessage("System", `Received unknown message type: ${data.type}`);
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                appendMessage("You", input.value);
                ws.send(input.value);
                input.value = '';
            }
        });

        function appendMessage(sender, text) {
            const item = document.createElement('div');
            item.className = 'message-container';
            item.innerHTML = `<b>${sender}:</b> <pre>${text}</pre>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        function appendToolCall(name, args) {
            const item = document.createElement('div');
            item.className = 'tool-call';
            item.innerHTML = `<b>Agent:</b> ⏺ Executing <b>${name}</b>...<details><summary>Arguments</summary><pre>${args}</pre></details>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        function tryParseJSON(str) {
            try {
                const obj = JSON.parse(str);
                return JSON.stringify(obj, null, 2); // Pretty print with 2 spaces
            } catch (e) {
                return str; // Return original string if not valid JSON
            }
        }

        function appendToolResult(name, result, isError) {
            const item = document.createElement('div');
            item.className = isError ? 'system-error' : 'tool-result';
            
            // 1. Create the preview text
            // Try to parse and format JSON
            const formattedResult = tryParseJSON(result.toString());
            const lines = formattedResult.split('\n');
            const preview = lines.slice(0, 3).join('\n') + (lines.length > 3 ? '...' : '');

            // 2. Create the container for the output section
            const outputContainer = document.createElement('div');
            
            // 3. Create the <details> and <summary> elements
            const details = document.createElement('details');
            const summary = document.createElement('summary');
            summary.className = 'details-summary';
            summary.textContent = 'Output';

            // 4. Create the preview span
            const previewSpan = document.createElement('span');
            previewSpan.className = 'preview-text';
            previewSpan.textContent = `: ${preview}`;

            // 5. Create the full content pre element
            const fullContentPre = document.createElement('pre');
            fullContentPre.textContent = formattedResult;
            if (formattedResult !== result.toString()) {
                // If it was valid JSON, add syntax highlighting
                fullContentPre.className = 'expanded-content hljs language-json';
                hljs.highlightElement(fullContentPre);
            } else {
                fullContentPre.className = 'expanded-content';
            }
            fullContentPre.className = 'expanded-content';
            
            // Initially, only the summary and preview are visible together
            summary.appendChild(previewSpan);
            details.appendChild(summary);
            details.appendChild(fullContentPre);

            // 6. Add event listener to hide/show preview
            details.addEventListener('toggle', (event) => {
                if (details.open) {
                    // When expanded, hide the preview text
                    previewSpan.style.display = 'none';
                } else {
                    // When collapsed, show the preview text
                    previewSpan.style.display = 'inline';
                }
            });

            item.innerHTML = `<b>${isError ? 'System' : 'Tool'}:</b> → Result from <b>${name}</b>`;
            item.appendChild(details);
            
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/me');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return false;
                } 
                const data = await response.json();
                return data.email;
            } catch (error) {
                console.error('Error checking authentication:', error);
                window.location.href = '/login.html';
                return false;
            }
        }
    </script>
</body>
</html>