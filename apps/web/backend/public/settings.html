<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Routekit - Settings</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        background-color: #f9fafb;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .nav {
        background-color: #f8f9fa;
        padding: 15px 0;
        border-bottom: 1px solid #eaeaea;
      }
      .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-brand {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        text-decoration: none;
      }
      .nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
      }
      .nav li {
        margin-left: 20px;
      }
      .nav a {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        padding: 5px 0;
      }
      .nav a:hover {
        color: #007bff;
      }
      .nav a.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
      }
      h1 {
        margin-bottom: 10px;
      }
      p {
        margin-top: 0;
        color: #666;
      }
      .content-wrapper {
        display: block;
      }
      .services-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }
      .card {
        border: 1px solid #eaeaea;
        border-radius: 8px;
        padding: 20px;
        background-color: white;
        margin-bottom: 20px;
      }
      .card-header {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card-header h2 {
        margin: 0;
        font-size: 18px;
        flex: 1;
      }
      .btn {
        display: inline-block;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        text-align: center;
      }
      .btn:hover {
        background-color: #0056b3;
      }
      .btn-danger {
        background-color: #dc3545;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      .btn-success {
        background-color: #28a745;
      }
      .btn-success:hover {
        background-color: #218838;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group textarea {
        height: 80px;
        resize: vertical;
      }
      .form-row {
        display: flex;
        gap: 15px;
      }
      .form-row .form-group {
        flex: 1;
      }
      .service-item {
        border: 1px solid #eaeaea;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fafbfc;
      }
      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .service-header h3 {
        margin: 0;
        font-size: 16px;
      }
      .service-details {
        font-size: 14px;
        color: #666;
      }
      .service-details div {
        margin-bottom: 5px;
      }
      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }
      .status-connected {
        background-color: #28a745;
      }
      .status-disconnected {
        background-color: #dc3545;
      }
      .message {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow-y: auto;
      }
      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-header h2 {
        margin: 0;
      }
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover {
        color: #000;
      }
      .auth-fields,
      .transport-fields {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <div class="nav-container">
        <a href="/" class="nav-brand">Routekit</a>
        <ul>
          <li><a href="/">Chat</a></li>
          <li><a href="/settings.html" class="active">Settings</a></li>
        </ul>
      </div>
    </div>
    <div class="container">
      <h1>Settings</h1>
      <p>Configure your AI providers and MCP services.</p>
      <div class="content-wrapper">
        <div class="services-container">
          <!-- LLM Providers Section -->
          <div class="card">
            <div class="card-header">
              <h2>AI Providers</h2>
              <button class="btn" onclick="openAddLLMModal()">
                + Add Provider
              </button>
            </div>
            <div id="llm-configs-list"><p>Loading AI providers...</p></div>
          </div>

          <!-- MCP Services Section -->
          <div class="card">
            <div class="card-header">
              <h2>MCP Services</h2>
              <button class="btn" onclick="openAddServiceModal()">
                + Add Service
              </button>
            </div>
            <div id="services-list"><p>Loading services...</p></div>
          </div>
          <div id="message-area" class="message"></div>
        </div>
      </div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New Service</h2>
          <span class="close" onclick="closeAddServiceModal()">×</span>
        </div>
        <form id="service-form">
          <div class="form-group">
            <label for="service-name">Service Name</label>
            <input
              type="text"
              id="service-name"
              name="display_name"
              required
              placeholder="GitHub"
            />
          </div>
          <div class="form-group">
            <label for="transport-type">Transport Type</label>
            <select id="transport-type" name="transport_type" required>
              <option value="">Select transport type...</option>
              <option value="streamable-http">Remote - HTTP</option>
              <option value="sse">Remote - SSE</option>
            </select>
          </div>

          <!-- Fields for Remote Transports -->
          <div id="remote-transport-fields" class="transport-fields">
            <div class="form-group">
              <label for="mcp-server-url">MCP Server URL</label>
              <input
                type="url"
                id="mcp-server-url"
                name="mcp_server_url"
                placeholder="https://api.example.com/mcp"
              />
            </div>
            <div class="form-group">
              <label for="auth-type">Authentication Type</label>
              <select id="auth-type" name="auth_type">
                <option value="no_auth">No Authentication</option>
                <option value="pat">Personal Access Token (Bearer)</option>
                <option value="api_key_in_header">API Key (in Header)</option>
                <option value="api_key_in_url">API Key (in URL)</option>
                <option value="oauth2.1">OAuth 2.1</option>
                <option value="mcp_remote_managed">Managed (for SSE)</option>
              </select>
            </div>
          </div>


          <!-- Fields for PAT Auth -->
          <div id="pat-fields" class="auth-fields">
            <div class="form-group">
              <label for="pat-token">Personal Access Token (PAT)</label>
              <input type="password" id="pat-token" name="token" />
            </div>
          </div>

          <!-- Fields for API Key in Header -->
          <div id="api-key-header-fields" class="auth-fields">
            <div class="form-group">
              <label for="api-key-header-name">Header Name</label>
              <input
                type="text"
                id="api-key-header-name"
                name="header_name"
                placeholder="e.g., X-API-Key"
              />
            </div>
            <div class="form-group">
              <label for="api-key-header-value">API Key</label>
              <input type="password" id="api-key-header-value" name="api_key" />
            </div>
          </div>

          <!-- Fields for API Key in URL -->
          <div id="api-key-url-fields" class="auth-fields">
            <div class="form-group">
              <label for="api-key-url-param">Query Parameter Name</label>
              <input
                type="text"
                id="api-key-url-param"
                name="query_param_name"
                placeholder="e.g., api_key"
              />
            </div>
            <div class="form-group">
              <label for="api-key-url-value">API Key</label>
              <input
                type="password"
                id="api-key-url-value"
                name="api_key_url"
              />
            </div>
          </div>

          <!-- Fields for OAuth 2.1 -->
          <div id="oauth-fields" class="auth-fields">
            <div class="form-row">
              <div class="form-group">
                <label for="client-id">Client ID</label>
                <input
                  type="text"
                  id="client-id"
                  name="client_id"
                  placeholder="Your OAuth client ID"
                />
              </div>
              <div class="form-group">
                <label for="client-secret">Client Secret</label>
                <input
                  type="password"
                  id="client-secret"
                  name="client_secret"
                  placeholder="Your OAuth client secret"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="authorization-url">Authorization URL</label>
                <input
                  type="url"
                  id="authorization-url"
                  name="authorization_url"
                  placeholder="https://provider.com/oauth/authorize"
                />
              </div>
              <div class="form-group">
                <label for="token-url">Token URL</label>
                <input
                  type="url"
                  id="token-url"
                  name="token_url"
                  placeholder="https://provider.com/oauth/token"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="scopes">Scopes (optional)</label>
              <textarea
                id="scopes"
                name="scopes"
                placeholder="read write admin (space-separated)"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="audience">Audience (optional)</label>
              <input
                type="text"
                id="audience"
                name="audience"
                placeholder="api.example.com"
              />
            </div>
          </div>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              onclick="closeAddServiceModal()"
              style="margin-right: 10px"
            >
              Cancel
            </button>
            <button type="submit" class="btn">Add Service</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add LLM Provider Modal -->
    <div id="addLLMModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add AI Provider</h2>
          <span class="close" onclick="closeAddLLMModal()">×</span>
        </div>
        <form id="llm-form">
          <div class="form-group">
            <label for="provider-type">Provider Type</label>
            <select id="provider-type" name="provider_type" required>
              <option value="">Select provider...</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="openai">OpenAI (GPT)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="api-key">API Key</label>
            <input
              type="password"
              id="api-key"
              name="api_key"
              required
              placeholder="Enter your API key"
            />
          </div>
          <div class="form-group">
            <label for="base-url">Base URL (optional)</label>
            <input
              type="url"
              id="base-url"
              name="base_url"
              placeholder="Custom endpoint (e.g., Azure OpenAI)"
            />
          </div>
          <div class="form-group">
            <label for="model">Model (optional)</label>
            <input
              type="text"
              id="model"
              name="model"
              placeholder="Default model to use"
            />
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input
                type="checkbox"
                id="is-default"
                name="is_default"
                style="width: auto;"
              />
              Set as default provider
            </label>
          </div>
          <div style="text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" onclick="testLLMConfig()" class="btn btn-success">
              Test Configuration
            </button>
            <button
              type="button"
              onclick="closeAddLLMModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn">Save Provider</button>
          </div>
        </form>
        <div id="test-results" style="margin-top: 15px; display: none;"></div>
      </div>
    </div>

    <script>
      const transportSelect = document.getElementById("transport-type");
      const authSelect = document.getElementById("auth-type");

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await checkAuth();
          await loadLLMConfigs();
          await loadServices();
          transportSelect.addEventListener("change", updateFormVisibility);
          authSelect.addEventListener("change", updateFormVisibility);
          updateFormVisibility(); // Initial call
        } catch (e) {
          // checkAuth handles redirect
        }
      });

      // LLM Provider Management Functions
      async function loadLLMConfigs() {
        const configsList = document.getElementById("llm-configs-list");
        try {
          const response = await fetch("/api/user/llm-config");
          if (!response.ok) throw new Error("Failed to load LLM configurations");

          const data = await response.json();
          const configs = data.configs || [];

          configsList.innerHTML = "";
          if (configs.length === 0) {
            configsList.innerHTML =
              '<p>No AI providers configured yet. Click "Add Provider" to get started.</p>';
            return;
          }

          configs.forEach((config) => {
            const providerName = config.provider_type === 'anthropic' ? 'Anthropic (Claude)' : 'OpenAI (GPT)';
            const defaultBadge = config.is_default ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-left: 8px;">Default</span>' : '';
            
            const configHtml = `
              <div class="service-item">
                <div class="service-header">
                  <h3>${providerName}${defaultBadge}</h3>
                  <div style="display: flex; gap: 8px;">
                    ${!config.is_default ? `<button class="btn btn-success" onclick="setDefaultProvider('${config.id}')">Set Default</button>` : ''}
                    <button class="btn btn-danger" onclick="deleteLLMConfig('${config.id}')">Delete</button>
                  </div>
                </div>
                <div class="service-details">
                  <div><strong>Provider:</strong> ${config.provider_type}</div>
                  ${config.model ? `<div><strong>Model:</strong> ${config.model}</div>` : ""}
                  ${config.base_url ? `<div><strong>Base URL:</strong> ${config.base_url}</div>` : ""}
                  <div><strong>Created:</strong> ${new Date(config.created_at).toLocaleDateString()}</div>
                </div>
              </div>`;
            configsList.insertAdjacentHTML("beforeend", configHtml);
          });
        } catch (error) {
          configsList.innerHTML =
            "<p>Error loading AI providers: " + error.message + "</p>";
        }
      }

      function openAddLLMModal() {
        document.getElementById("llm-form").reset();
        document.getElementById("test-results").style.display = "none";
        document.getElementById("addLLMModal").style.display = "block";
      }

      function closeAddLLMModal() {
        document.getElementById("addLLMModal").style.display = "none";
      }

      document.getElementById("llm-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const llmData = {
          provider_type: formData.get("provider_type"),
          api_key: formData.get("api_key"),
          base_url: formData.get("base_url") || "",
          model: formData.get("model") || "",
          is_default: formData.get("is_default") === "on"
        };

        try {
          const response = await fetch("/api/user/llm-config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(llmData),
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to add provider");
          }
          
          showMessage("AI provider added successfully!", "success");
          closeAddLLMModal();
          await loadLLMConfigs();
        } catch (error) {
          showMessage("Error adding provider: " + error.message, "error");
        }
      });

      async function testLLMConfig() {
        const form = document.getElementById("llm-form");
        const formData = new FormData(form);
        const testData = {
          provider_type: formData.get("provider_type"),
          api_key: formData.get("api_key"),
          base_url: formData.get("base_url") || "",
          model: formData.get("model") || ""
        };

        if (!testData.provider_type || !testData.api_key) {
          showMessage("Please fill in provider type and API key first", "error");
          return;
        }

        const testButton = document.querySelector('button[onclick="testLLMConfig()"]');
        const originalText = testButton.textContent;
        testButton.textContent = "Testing...";
        testButton.disabled = true;

        try {
          const response = await fetch("/api/user/llm-config/test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testData),
          });

          const result = await response.json();
          const resultsDiv = document.getElementById("test-results");
          
          if (result.success) {
            resultsDiv.innerHTML = `
              <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px;">
                <strong>✅ Test Successful!</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">
                  <strong>Test Response:</strong> ${result.test_response}<br>
                  <strong>Usage:</strong> ${result.usage.input_tokens} input, ${result.usage.output_tokens} output tokens<br>
                  <strong>Supported Models:</strong> ${result.supported_models.join(', ')}
                </div>
              </div>`;
          } else {
            resultsDiv.innerHTML = `
              <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px;">
                <strong>❌ Test Failed</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">${result.error}</div>
              </div>`;
          }
          resultsDiv.style.display = "block";
        } catch (error) {
          const resultsDiv = document.getElementById("test-results");
          resultsDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px;">
              <strong>❌ Test Failed</strong><br>
              <div style="margin-top: 8px; font-size: 14px;">${error.message}</div>
            </div>`;
          resultsDiv.style.display = "block";
        } finally {
          testButton.textContent = originalText;
          testButton.disabled = false;
        }
      }

      async function setDefaultProvider(configId) {
        try {
          const response = await fetch(`/api/user/llm-config/${configId}/default`, {
            method: "PUT",
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to set default provider");
          }
          
          showMessage("Default provider updated successfully!", "success");
          await loadLLMConfigs();
        } catch (error) {
          showMessage("Error setting default provider: " + error.message, "error");
        }
      }

      async function deleteLLMConfig(configId) {
        if (!confirm("Are you sure you want to delete this AI provider configuration?")) return;
        
        try {
          const response = await fetch(`/api/user/llm-config/${configId}`, {
            method: "DELETE",
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to delete provider");
          }
          
          showMessage("AI provider deleted successfully!", "success");
          await loadLLMConfigs();
        } catch (error) {
          showMessage("Error deleting provider: " + error.message, "error");
        }
      }

      function updateFormVisibility() {
        const transportType = transportSelect.value;
        const authType = authSelect.value;

        // Hide all conditional sections first
        document
          .querySelectorAll(".transport-fields, .auth-fields")
          .forEach((el) => (el.style.display = "none"));

        // Show fields based on transport type
        if (transportType === "streamable-http" || transportType === "sse") {
          document.getElementById("remote-transport-fields").style.display =
            "block";
          document.getElementById("mcp-server-url").required = true;

          authSelect.disabled = false;
          // For SSE, we default the auth type and disable the selector
          if (transportType === "sse") {
            authSelect.value = "mcp_remote_managed";
            authSelect.disabled = true;
          }

          // For remote transports, show auth fields based on auth type
          switch (authType) {
            case "pat":
              document.getElementById("pat-fields").style.display = "block";
              break;
            case "api_key_in_header":
              document.getElementById("api-key-header-fields").style.display =
                "block";
              break;
            case "api_key_in_url":
              document.getElementById("api-key-url-fields").style.display =
                "block";
              break;
            case "oauth2.1":
              document.getElementById("oauth-fields").style.display = "block";
              break;
          }
        } else {
          authSelect.disabled = false;
          document.getElementById("mcp-server-url").required = true;
        }
      }

      document
        .getElementById("service-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const serviceData = {};

          // Collect all form data
          for (const [key, value] of formData.entries()) {
            if (value) {
              serviceData[key] = value;
            }
          }


          // Handle the different api_key fields
          if (serviceData.auth_type === "api_key_in_url") {
            serviceData.api_key = formData.get("api_key_url");
            delete serviceData.api_key_url;
          }

          // Set auth_type for sse
          if (serviceData.transport_type === "sse")
            serviceData.auth_type = "mcp_remote_managed";

          try {
            const response = await fetch("/api/user/services", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(serviceData),
            });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Failed to add service");
            }
            showMessage("Service added successfully!", "success");
            closeAddServiceModal();
            await loadServices();
          } catch (error) {
            showMessage("Error adding service: " + error.message, "error");
          }
        });

      async function loadServices() {
        const servicesList = document.getElementById("services-list");
        try {
          const [servicesResponse, statusResponse] = await Promise.all([
            fetch("/api/user/services"),
            fetch("/api/connectors/status"),
          ]);

          if (!servicesResponse.ok) throw new Error("Failed to load services");
          if (!statusResponse.ok) throw new Error("Failed to load statuses");

          const services = (await servicesResponse.json()) || [];
          const statuses = (await statusResponse.json()) || {};

          servicesList.innerHTML = "";
          if (services.length === 0) {
            servicesList.innerHTML =
              '<p>No services configured yet. Click "Add Service" to get started.</p>';
            return;
          }

          services.forEach((service) => {
            const status = statuses[service.display_name];
            const isConnected = status?.connected || false;
            const statusText =
              service.auth_type === "mcp_remote_managed"
                ? "Ready (connects on-demand)"
                : isConnected
                  ? "Connected"
                  : "Not connected";

            const serviceHtml = `
                        <div class="service-item">
                            <div class="service-header">
                                <h3>${service.display_name}</h3>
                                <button class="btn btn-danger" onclick="deleteService('${service.id}')">Delete</button>
                            </div>
                            <div class="service-details">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="status-indicator ${isConnected ? "status-connected" : "status-disconnected"}"></div>
                                    <span>${statusText}</span>
                                </div>
                                <div><strong>Transport:</strong> ${service.transport_type}</div>
                                ${service.mcp_server_url ? `<div><strong>URL:</strong> ${service.mcp_server_url}</div>` : ""}
                                <div><strong>Auth:</strong> ${service.auth_type}</div>
                            </div>
                        </div>`;
            servicesList.insertAdjacentHTML("beforeend", serviceHtml);
          });
        } catch (error) {
          servicesList.innerHTML =
            "<p>Error loading services: " + error.message + "</p>";
        }
      }

      function openAddServiceModal() {
        document.getElementById("service-form").reset();
        updateFormVisibility();
        document.getElementById("addServiceModal").style.display = "block";
      }

      function closeAddServiceModal() {
        document.getElementById("addServiceModal").style.display = "none";
      }

      async function deleteService(serviceId) {
        if (!confirm("Are you sure you want to delete this service?")) return;
        try {
          const response = await fetch(`/api/user/services/${serviceId}`, {
            method: "DELETE",
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to delete service");
          }
          showMessage("Service deleted successfully!", "success");
          await loadServices();
        } catch (error) {
          showMessage("Error deleting service: " + error.message, "error");
        }
      }

      function showMessage(text, type) {
        const messageArea = document.getElementById("message-area");
        messageArea.textContent = text;
        messageArea.className = `message ${type}`;
        messageArea.style.display = "block";
        setTimeout(() => {
          messageArea.style.display = "none";
        }, 5000);
      }

      async function checkAuth() {
        try {
          const response = await fetch("/api/me");
          if (!response.ok) {
            window.location.href = "/login.html";
            throw new Error("Not authenticated");
          }
        } catch (error) {
          window.location.href = "/login.html";
          throw new Error("Not authenticated");
        }
      }
    </script>
  </body>
</html>
