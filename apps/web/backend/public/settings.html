<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Routekit - Settings</title>
    <!-- We'll use a library to parse YAML on the frontend -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; color: #333; background-color: #f9fafb; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav { background-color: #f8f9fa; padding: 15px 0; border-bottom: 1px solid #eaeaea; }
        .nav ul { list-style: none; padding: 0; margin: 0; display: flex; }
        .nav li { margin-left: 20px; }
        .nav a { text-decoration: none; color: #333; font-weight: 500; }
        .nav a.active { color: #007bff; border-bottom: 2px solid #007bff; }
        h1 { margin-bottom: 10px; }
        p { margin-top: 0; color: #666; }
        .content-wrapper { display: flex; gap: 20px; align-items: flex-start; }
        .editor-container { flex: 2; }
        .status-container { flex: 1; }
        textarea { width: 100%; height: 60vh; font-family: monospace; font-size: 14px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .message { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .card { border: 1px solid #eaeaea; border-radius: 8px; padding: 20px; background-color: white; }
        .card-header { margin-bottom: 15px; }
        .card-header h2 { margin: 0; font-size: 18px; }
        .connector-info { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eaeaea; }
        .connector-info:last-child { border-bottom: none; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .btn { display: inline-block; background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div class="nav">
        <div class="container">
            <ul>
                <li><a href="/">Chat</a></li>
                <li><a href="/settings.html" class="active">Settings</a></li>
            </ul>
        </div>
    </div>
    <div class="container">
        <h1>Service Configuration</h1>
        <p>Define the MCP services you want Routekit to connect to using YAML. This configuration is the source of truth for your agent.</p>
        <div class="content-wrapper">
            <div class="editor-container">
                <form id="config-form">
                    <textarea id="config-yaml" placeholder="version: 1
services:
  - name: my-service
    ..."></textarea>
                    <button type="submit">Save Configuration</button>
                </form>
                <div id="message-area" class="message"></div>
            </div>
            <div class="status-container">
                <div class="card">
                    <div class="card-header">
                        <h2>Connection Status</h2>
                    </div>
                    <div id="connectors-status-list">
                        <p>Save your configuration to see connection statuses.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Authenticate user or redirect to login ---
            try {
                await checkAuth();
            } catch(e) {
                return; // checkAuth handles the redirect
            }

            const configTextarea = document.getElementById('config-yaml');
            const configForm = document.getElementById('config-form');
            const messageArea = document.getElementById('message-area');
            const statusList = document.getElementById('connectors-status-list');

            // --- Load existing config on page load ---
            try {
                const response = await fetch('/api/user/services');
                if (response.ok) {
                    const data = await response.json();
                    if (data.config_yaml) {
                        configTextarea.value = data.config_yaml;
                    } else {
                        // Pre-populate with a helpful example if the user has no config yet
                        configTextarea.value = `# Example Service Configurations\n` +
                            `version: 1\n` +
                            `services:\n` +
                            `  - name: github\n` +
                            `    transport: streamable-http\n` +
                            `    url: https://api.githubcopilot.com/mcp\n` +
                            `    auth:\n` +
                            `      type: pat\n\n` +
                            `  - name: atlassian\n` +
                            `    transport: stdio\n` +
                            `    command: ["npx", "-y", "mcp-remote", "https://mcp.atlassian.com/v1/sse", "--host", "localhost"]\n` +
                            `    auth:\n` +
                            `      type: oauth2.1\n` +
                            `      authorization_url: "https://auth.atlassian.com/authorize"\n` +
                            `      token_url: "https://auth.atlassian.com/oauth/token"\n` +
                            `      client_id_env: "ATLASSIAN_CLIENT_ID"\n` +
                            `      client_secret_env: "ATLASSIAN_CLIENT_SECRET"\n` +
                            `      scopes:\n` +
                            `        - "read:jira-work"\n` +
                            `        - "write:jira-work"\n` +
                            `        - "read:jira-user"\n` +
                            `        - "offline_access"\n` +
                            `      audience: "api.atlassian.com"\n\n`+
                            `  - name: linear\n` +
                            `    transport: stdio\n` +
                            `    command: ["npx", "-y", "mcp-remote", "https://mcp.linear.app/sse", "--host", "localhost"]\n` +
                            `    auth:\n` +
                            `      type: oauth2.1\n` +
                            `      authorization_url: "https://linear.app/oauth/authorize"\n` +
                            `      token_url: "https://api.linear.app/oauth/token"\n` +
                            `      client_id_env: "LINEAR_CLIENT_ID"\n` +
                            `      client_secret_env: "LINEAR_CLIENT_SECRET"\n` +
                            `      scopes: ["read", "write"]`;
                    }
                    await renderStatusUI();
                } else {
                    showMessage('Could not load your configuration.', 'error');
                }
            } catch (error) {
                showMessage('Error loading configuration: ' + error.message, 'error');
            }

            // --- Handle form submission to save the YAML config ---
            configForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const configYAML = configTextarea.value;
                try {
                    const response = await fetch('/api/user/services', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ config_yaml: configYAML })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to save configuration.');
                    showMessage('Configuration saved successfully!', 'success');
                    await renderStatusUI(); // Re-render statuses after saving
                } catch (error) {
                    showMessage('Error saving configuration: ' + error.message, 'error');
                }
            });

            // --- Main UI rendering function ---
            async function renderStatusUI() {
                statusList.innerHTML = '<p>Loading statuses...</p>';
                try {
                    const [statusRes, configRes] = await Promise.all([
                        fetch('/api/connectors/status'),
                        fetch('/api/user/services')
                    ]);
                    if (!statusRes.ok || !configRes.ok) throw new Error('Failed to fetch data to render UI.');

                    const statuses = await statusRes.json();
                    const configData = await configRes.json();
                    if (!configData.config_yaml) {
                         statusList.innerHTML = '<p>Save a configuration to see connection statuses.</p>';
                         return;
                    }
                    const userConfig = jsyaml.load(configData.config_yaml);

                    statusList.innerHTML = '';
                    if (!userConfig || !userConfig.services) {
                        statusList.innerHTML = '<p>No services defined in your configuration.</p>';
                        return;
                    }

                    userConfig.services.forEach(service => {
                        const isConnected = statuses[service.name]?.connected || false;
                        const authType = service.auth?.type;

                        let connectActionHtml = '';
                        // Dynamically create the correct button/link based on auth type
                        if (!isConnected) {
                            if (authType === 'pat' || authType === 'api_key') {
                                connectActionHtml = `<button class="btn" data-action="connect_token">Connect</button>`;
                            } else if (authType === 'oauth2.1') {
                                // This now correctly points to the generic OAuth endpoint
                                connectActionHtml = `<a href="/api/connectors/${service.name}/oauth" class="btn">Connect</a>`;
                            }
                        }

                        const connectorHtml = `
                            <div class="connector-info" data-service="${service.name}">
                                <div>
                                    <h3>${service.name}</h3>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="status-indicator ${isConnected ? 'status-connected' : 'status-disconnected'}"></div>
                                        <span>${isConnected ? 'Connected' : 'Disconnected'}</span>
                                    </div>
                                </div>
                                <div class="connector-actions">
                                    ${isConnected ? `<button class="btn btn-danger" data-action="disconnect">Disconnect</button>` : connectActionHtml}
                                </div>
                            </div>`;
                        statusList.insertAdjacentHTML('beforeend', connectorHtml);
                    });

                } catch (error) {
                    console.error("Error rendering status UI:", error);
                    statusList.innerHTML = '<p>Could not load connection statuses. Please check your YAML and save again.</p>';
                }
            }

            // --- Generic event handler for all buttons in the status list ---
            statusList.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return; // Ignore clicks that aren't on a button

                e.preventDefault();
                const serviceName = button.closest('.connector-info').dataset.service;
                const action = button.dataset.action;

                if (action === 'disconnect') {
                    if (!confirm(`Are you sure you want to disconnect ${serviceName}?`)) return;
                    await fetch(`/api/connectors/${serviceName}`, { method: 'DELETE' });
                    await renderStatusUI();
                } else if (action === 'connect_token') {
                    const token = prompt(`Please enter your Personal Access Token for ${serviceName}:`);
                    if (token) {
                        // Point to the specific endpoint for token-based auth
                        await fetch(`/api/connectors/${serviceName}/token`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token })
                        });
                        await renderStatusUI();
                    }
                }
            });

            function showMessage(text, type) {
                messageArea.textContent = text;
                messageArea.className = `message ${type}`;
                messageArea.style.display = 'block';
                setTimeout(() => { messageArea.style.display = 'none'; }, 5000);
            }
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/me');
                if (!response.ok) window.location.href = '/login.html';
            } catch (error) {
                window.location.href = '/login.html';
            }
        }
    </script>
</body>
</html>